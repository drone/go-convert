stages:
- name: build
  spec:
    platform:
      arch: amd64
      os: linux
    runtime:
      spec: {}
      type: cloud
    steps:
    - name: datadog_setup
      spec:
        envs:
          PARAM_DD_AGENT_MAJOR_VERSION: "7"
          PARAM_DD_API_KEY: DATADOG_API_KEY
          PARAM_DD_SITE: datadoghq.com
        run: |-
          PARAM_DD_API_KEY=$(eval echo "\$PARAM_DD_API_KEY")
          if [ -n "${DD_SITE}" ]; then
            PARAM_DD_SITE=${DD_SITE}
          fi
          DD_API_KEY=${PARAM_DD_API_KEY} DD_AGENT_MAJOR_VERSION=${PARAM_DD_AGENT_MAJOR_VERSION} DD_SITE=${PARAM_DD_SITE} \
          DD_HOSTNAME="none" DD_INSTALL_ONLY="true" DD_APM_ENABLED="true" \
          bash -c "$(curl -L https://s3.amazonaws.com/dd-agent/scripts/install_script_agent7.sh)"
          find /etc/datadog-agent/conf.d/ -iname "*.yaml.default" -delete
          service datadog-agent start
          set +e
          attempts=0
          until [ $attempts -eq 10 ] || datadog-agent health; do
          attempts=$((attempts+1))
          sleep_time=$(( attempts*5 < 30 ? attempts*5 : 30 ))
          echo "Waiting for agent to start up sleeping for ${sleep_time} seconds"
          sleep $sleep_time
          done
          if [ $attempts -eq 10 ]; then
          echo "Could not start the agent"
          exit 1
          else
          echo "Agent is ready"
          fi
      type: script
    - name: datadog_stop
      spec:
        run: service datadog-agent stop
      type: script
  type: ci
version: 1

