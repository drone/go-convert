version: 1
pipeline:
  env:
    BRANCH_NAME: <+trigger.branch>
    BUILD_ID: <+pipeline.sequenceId>
    COMMIT_SHA: <+trigger.commitSha>
    PROJECT_ID: <+project.name>
    PROJECT_NUMBER: <+pipeline.sequenceId>
    REPO_NAME: <+trigger.payload.repository.name>
    REVISION_ID: <+trigger.commitSha>
    SHORT_SHA: <+codebase.shortCommitSha>
    TAG_NAME: <+trigger.commitSha>
  stages:
  - platform:
      arch: amd64
      os: linux
    runtime:
      cloud: {}
    volumes:
      - name: dockersock
        uses: bind
        with:
          path: /var/run/docker.sock
    steps:
      - name: docker
        run:
          container:
            args:
            - build
            - -t
            - gcr.io/myproject/myimage
            - .
            image: gcr.io/cloud-builders/docker
            volumes:
            - source: dockersock
              target: /var/run/docker.sock

      - name: kubectl
        run:
          container:
            args:
            - set
            - image
            - deployment/myimage
            - frontend=gcr.io/myproject/myimage
            image: gcr.io/cloud-builders/kubectl
            volumes:
            - source: dockersock
              target: /var/run/docker.sock
          env:
            CLOUDSDK_COMPUTE_ZONE: us-east1-b
            CLOUDSDK_CONTAINER_CLUSTER: node-example-cluster

